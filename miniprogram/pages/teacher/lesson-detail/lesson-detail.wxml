<view class="container">
  <van-loading wx:if="{{ loading }}" size="24px" color="var(--accent-color)" vertical>加载中...</van-loading>

  <block wx:if="{{ !loading && lesson }}">
    <view class="status-bar">
      <van-tag
        type="{{ lesson.status === 'cancelled' ? 'danger' : lesson.status === 'completed' ? 'success' : 'primary' }}"
        size="large"
      >{{ statusLabels[lesson.status] }}</van-tag>
    </view>

    <view class="card detail-card">
      <view class="detail-title">{{ lesson.courseName }}</view>

      <view class="detail-row">
        <text class="detail-label">日期</text>
        <text class="detail-value">{{ lesson.date }}</text>
      </view>
      <view class="detail-row">
        <text class="detail-label">时间</text>
        <text class="detail-value">{{ lesson.startTime }} - {{ lesson.endTime }}</text>
      </view>
      <view class="detail-row" wx:if="{{ lesson.location }}">
        <text class="detail-label">地点</text>
        <text class="detail-value">{{ lesson.location }}</text>
      </view>

      <view class="section-title" style="margin-top: var(--spacing-lg);">学生名单</view>
      <view class="student-list">
        <text
          wx:for="{{ lesson.studentNames }}"
          wx:key="*this"
          class="student-item"
        >{{ item }}</text>
      </view>
    </view>

    <!-- 已有反馈展示 -->
    <view class="card feedback-card" wx:if="{{ feedback && !showFeedbackForm }}">
      <view class="flex-between">
        <view class="section-title">我的反馈</view>
        <van-button size="mini" bind:tap="goEditFeedback">编辑</van-button>
      </view>
      <view class="feedback-content">{{ feedback.content }}</view>
      <view class="feedback-images" wx:if="{{ feedback.images && feedback.images.length > 0 }}">
        <image
          wx:for="{{ feedback.images }}"
          wx:key="*this"
          src="{{ item }}"
          mode="aspectFill"
          class="feedback-img"
          bind:tap="previewImage"
          data-url="{{ item }}"
          data-urls="{{ feedback.images }}"
        />
      </view>
    </view>

    <!-- 反馈表单（新建或编辑） -->
    <view class="card" wx:if="{{ showFeedbackForm }}">
      <view class="flex-between" style="margin-bottom: var(--spacing-md);">
        <view class="section-title">{{ feedback ? '编辑反馈' : '撰写反馈' }}</view>
        <van-button size="mini" bind:tap="cancelFeedback">取消</van-button>
      </view>
      <feedback-form
        id="feedbackForm"
        lessonId="{{ lessonId }}"
        feedback="{{ feedback }}"
        bind:submit="onFeedbackSubmit"
      />
    </view>

    <!-- 写反馈按钮（课程已完成且无反馈且未展开表单） -->
    <view class="action-bar" wx:if="{{ lesson.status === 'completed' && !feedback && !showFeedbackForm }}">
      <van-button type="primary" custom-class="btn-accent" block round bind:click="goWriteFeedback">
        写反馈
      </van-button>
    </view>
  </block>

  <van-empty wx:if="{{ !loading && !lesson }}" description="课程不存在" />
</view>
