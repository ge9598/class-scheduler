# 授课管理系统 - 实施工作流

## 工作流总览

```
Phase 0: 项目初始化
    │
Phase 1: 基础设施层
    │
    ├──────────────────────┐
Phase 2: 管理员排课      Phase 3: 日历与组件 (组件部分可并行)
    │                      │
    ├──────────────────────┘
    │
    ├──────────────┬──────────────┐
Phase 4: 消息推送  Phase 5: 反馈  Phase 6: 管理后台完善
    │              │              │
    ├──────────────┴──────────────┘
    │
Phase 7: P2增强功能
    │
Phase 8: 质量保障与上线
```

---

## Phase 0: 项目初始化

**目标**: 搭建可运行的项目骨架

| # | 任务 | 产出 |
|---|------|------|
| 0.1 | 微信开发者工具创建小程序项目 | 项目脚手架 |
| 0.2 | 初始化云开发环境 | 云开发环境可用 |
| 0.3 | 集成 Vant Weapp 组件库 | npm 构建完成 |
| 0.4 | 创建目录结构（pages/components/utils/cloudfunctions） | 完整目录树 |
| 0.5 | 配置 app.json（tabBar、全局样式、分包） | 应用配置 |
| 0.6 | 搭建公共工具模块（utils/date.js, utils/api.js） | 工具函数 |
| 0.7 | 配置全局样式变量（app.wxss） | 主题色、字体、间距 |

**验收标准**: 项目在微信开发者工具中正常运行，Vant 组件可引用，云开发控制台可访问

**依赖**: 无

---

## Phase 1: 基础设施层

**目标**: 完成认证体系和数据层

| # | 任务 | 产出 |
|---|------|------|
| 1.1 | 创建云数据库集合（users/courses/lessons/feedbacks/enrollments） | 5个集合 + 索引 |
| 1.2 | 设置数据库安全规则（权限控制） | 安全规则配置 |
| 1.3 | 开发云函数 `login`（获取openid、查询/创建用户、返回角色） | 登录云函数 |
| 1.4 | 前端登录流程（wx.cloud.callFunction → 存储用户信息到本地） | 登录页 |
| 1.5 | 封装 utils/auth.js（角色判断、登录态检查、权限守卫） | 权限工具 |
| 1.6 | 封装 utils/api.js（云函数调用统一封装、错误处理、loading） | API工具 |
| 1.7 | 实现角色路由分发（登录后根据角色跳转不同tabBar） | 角色路由 |

**验收标准**:
- 用户微信登录后获取正确 openid
- 角色正确识别并路由到对应端
- 未登录用户被拦截到登录页

**依赖**: Phase 0

---

## Phase 2: 管理员排课（P0 核心）

**目标**: 管理员可完成排课全流程

| # | 任务 | 产出 |
|---|------|------|
| 2.1 | 开发云函数 `userManage`（管理员增删改查用户） | 用户管理API |
| 2.2 | 开发云函数 `courseManage`（课程模板CRUD） | 课程管理API |
| 2.3 | 开发云函数 `lessonManage`（排课创建/编辑/取消/标记完成） | 排课管理API |
| 2.4 | 管理员端 - 用户管理页（添加老师/学生，列表展示） | admin/users |
| 2.5 | 管理员端 - 课程模板管理页（创建/编辑/删除课程模板） | admin/courses |
| 2.6 | 管理员端 - 排课页面（选课程/老师/学生/日期/时间/地点） | admin/schedule |
| 2.7 | 排课表单校验（时间冲突检测、必填项验证） | 业务校验逻辑 |
| 2.8 | 云函数权限中间件（校验调用者是否为admin） | 服务端权限校验 |

**验收标准**:
- 管理员可添加老师和学生
- 管理员可创建课程模板
- 管理员可创建排课（指定课程/老师/学生/时间）
- 管理员可编辑、取消、标记完成排课
- 非管理员调用管理接口被拒绝

**依赖**: Phase 1

---

## Phase 3: 日历视图（P0 核心）

**目标**: 三端用户通过日历查看课程

| # | 任务 | 产出 |
|---|------|------|
| 3.1 | 开发日历组件 `components/calendar`（月视图、标记点、滑动切换） | 日历组件 |
| 3.2 | 开发课程卡片组件 `components/lesson-card`（课程名/时间/老师/地点） | 卡片组件 |
| 3.3 | 开发云函数 `lessonQuery`（按角色/日期查询，自动权限过滤） | 查询API |
| 3.4 | 学生端日历首页（月视图 + 当日课程列表） | student/calendar |
| 3.5 | 老师端日历首页（月视图 + 当日课程列表，显示学生名单） | teacher/calendar |
| 3.6 | 管理员端全局日历（所有课程 + 按老师/课程筛选） | admin/calendar |
| 3.7 | 学生端课程详情页 | student/lesson-detail |
| 3.8 | 老师端课程详情页（含学生名单） | teacher/lesson-detail |
| 3.9 | 管理员端课程详情页 | admin/lesson-detail |

**验收标准**:
- 日历组件正确标记有课日期
- 点击日期展示当天课程卡片列表
- 左右滑动切换月份流畅
- 学生只看到自己的课，老师只看到自己教的课
- 管理员能看到所有课程
- 点击卡片进入详情页，信息完整

**依赖**: Phase 1 + Phase 2（需要排课数据）
**可并行部分**: 3.1、3.2 组件开发不依赖 Phase 2

---

## Phase 4: 消息推送（P0 核心）

**目标**: 课前15分钟微信推送提醒

| # | 任务 | 产出 |
|---|------|------|
| 4.1 | 微信公众平台申请订阅消息模板（上课提醒） | 模板ID |
| 4.2 | 前端订阅引导（在自然交互节点调用 wx.requestSubscribeMessage） | 订阅引导逻辑 |
| 4.3 | 开发云函数 `sendReminder`（查询15分钟内课程 + 发送推送） | 提醒云函数 |
| 4.4 | 配置定时触发器（每5分钟执行 sendReminder） | 触发器配置 |
| 4.5 | 兜底方案：应用内 banner/弹窗提醒未订阅用户 | 应用内提醒 |
| 4.6 | 推送记录与防重复发送（reminderSent 标记） | 防重复机制 |

**验收标准**:
- 已订阅用户课前15分钟收到微信推送
- 推送内容包含课程名、时间、老师、地点
- 不会重复发送
- 未订阅用户在小程序内看到提醒

**依赖**: Phase 2（需要 lessons 数据）
**风险**: 一次性订阅消息限制，需精心设计引导时机

---

## Phase 5: 反馈系统（P1）

**目标**: 老师课后写反馈，三方可查看

| # | 任务 | 产出 |
|---|------|------|
| 5.1 | 开发云函数 `feedbackManage`（提交/编辑/查询反馈） | 反馈API |
| 5.2 | 开发反馈表单组件 `components/feedback-form`（文字+图片上传） | 反馈组件 |
| 5.3 | 老师端 - 课程详情页增加"写反馈"入口（status=completed时） | 写反馈功能 |
| 5.4 | 图片上传至云存储（最多9张） | 图片上传 |
| 5.5 | 学生端/管理员端 - 课程详情页增加"查看反馈"区域 | 查看反馈 |
| 5.6 | 反馈编辑功能（老师可修改已提交的反馈） | 反馈编辑 |

**验收标准**:
- 课程完成后老师可写反馈（文字+图片）
- 反馈提交后学生、管理员可在课程详情中查看
- 老师可编辑已提交的反馈
- 图片上传和预览正常

**依赖**: Phase 3（课程详情页作为入口）

---

## Phase 6: 管理后台完善（P1）

**目标**: 完善管理功能和个人中心

| # | 任务 | 产出 |
|---|------|------|
| 6.1 | 用户管理页完善（按角色筛选、搜索、编辑、删除） | 完整用户管理 |
| 6.2 | 课程模板管理页完善（列表、编辑、删除确认） | 完整课程管理 |
| 6.3 | 学生端个人中心（头像、姓名、手机号、通知开关） | student/profile |
| 6.4 | 老师端个人中心（头像、姓名、今日课程快捷入口） | teacher/profile |
| 6.5 | 管理员端个人中心 | admin/profile |

**验收标准**:
- 用户管理支持筛选、搜索、CRUD
- 个人中心信息展示完整
- 通知开关可引导订阅

**依赖**: Phase 1 + Phase 2
**可与 Phase 5 并行**

---

## Phase 7: P2 增强功能

**目标**: 购课管理和批量排课

| # | 任务 | 产出 |
|---|------|------|
| 7.1 | 开发云函数 `enrollmentManage`（购课记录CRUD + 课时计算） | 购课API |
| 7.2 | 管理员端 - 购课管理页（添加购课记录、查看消耗） | admin/enrollments |
| 7.3 | 学生端 - 我的课程页（课程列表 + 课时统计） | student/my-courses |
| 7.4 | 排课完成时自动扣减课时（lessonManage 联动 enrollment） | 课时联动 |
| 7.5 | 批量排课功能（按周重复，生成N条记录） | 批量排课 |
| 7.6 | 管理员全局筛选视图（按老师/课程筛选日历） | 筛选功能 |

**验收标准**:
- 学生可查看购课记录和剩余课时
- 课程完成自动扣减课时
- 批量排课按周重复可正确生成多条记录
- 管理员可按条件筛选课程日历

**依赖**: Phase 2 + Phase 3

---

## Phase 8: 质量保障与上线

**目标**: 确保质量，通过审核上线

| # | 任务 | 产出 |
|---|------|------|
| 8.1 | 全流程端到端测试（三个角色完整流程） | 测试报告 |
| 8.2 | 性能优化（日历渲染、云函数冷启动、数据查询） | 性能优化 |
| 8.3 | 安全审查（云函数权限校验、数据库安全规则） | 安全审查 |
| 8.4 | 隐私协议与用户协议编写 | 合规文档 |
| 8.5 | 小程序体验版测试 | 体验版 |
| 8.6 | 提交微信小程序审核 | 审核提交 |
| 8.7 | 上线发布 | 正式版 |

**验收标准**:
- 三角色全流程无阻断
- 云函数响应时间 < 3s
- 所有接口服务端权限校验通过
- 通过小程序审核

**依赖**: 所有前序阶段

---

## 技术风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| 订阅消息一次性限制 | 用户可能收不到提醒 | 多节点引导订阅 + 应用内兜底提醒 |
| 日历组件性能 | 大量课程时卡顿 | 按月分页加载、虚拟列表 |
| 云函数冷启动延迟 | 首次调用慢 | 定时预热、精简函数体积 |
| 数据一致性 | 课时扣减错误 | 云函数事务/原子操作 |
| 小程序审核 | 审核不通过 | 提前准备合规文档、规范用户信息收集 |

---

## 关键设计决策

1. **角色路由方案**: 登录后根据 role 字段跳转不同 tabBar 配置（三套 tabBar）
2. **数据冗余策略**: lessons 表冗余 teacherName/studentNames，避免日历页大量关联查询
3. **时区统一**: 所有时间使用北京时间（UTC+8），前端展示直接使用
4. **图片存储**: 使用云存储，反馈图片以 `feedbacks/{lessonId}/{timestamp}` 路径存储
5. **订阅引导时机**: 查看课表时、进入小程序时、查看课程详情时

---

## 执行建议

- **Phase 0-1** 是基础，务必打牢，尤其是权限体系
- **Phase 2-3** 是核心价值，完成后即可内部试用
- **Phase 4** 涉及微信平台审核，建议尽早申请订阅消息模板
- **Phase 5-6** 可并行开发，加速交付
- **Phase 7** 属于增强功能，可根据实际使用反馈决定优先级
